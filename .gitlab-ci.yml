image: docker:17.06

stages:
    - test

test-codereview:
    stage: test
    environment: testing
    script:
        - docker run --rm --tty --volume "$PWD":/code --volume /var/run/docker.sock:/var/run/docker.sock --volume /tmp/cc:/tmp/cc --env CODECLIMATE_CODE="$PWD" --env CONTAINER_TIMEOUT_SECONDS=3600 codeclimate/codeclimate:0.78.1 analyze -e phpmd -e eslint -f html > codereview.html && cat codereview.html | grep -i 'no issue'
    artifacts:
        when: always
        paths: [codereview.html]
    only:
        - testing

test-unitary:
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
        MOUNT_POINT: /builds/$CI_PROJECT_PATH/tests
    services:
        - rabbitmq:3.6-management
        - docker:dind
    stage: test
    environment: testing
    before_script:
        - find . -type d -exec chmod 755 {} +
        - find . -type f -exec chmod 644 {} +
        - find ./ci -type f -exec chmod 755 {} +
    script:
        - ls -l /builds/$CI_PROJECT_PATH
    artifacts:
        when: always
        paths: [test/result_test.html]
    only:
        - testing
